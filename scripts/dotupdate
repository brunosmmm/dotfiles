#!/usr/bin/env python3
"""Update dotfiles from current user's home directory."""

import os
import shutil
from argparse import ArgumentParser

from dotutils.git import GitDotfileInspector

if __name__ == "__main__":

    parser = ArgumentParser()
    parser.add_argument("p", help="dot files storage path")
    parser.add_argument(
        "--home", help="home directory path", default=os.environ["HOME"]
    )
    parser.add_argument(
        "--quiet", help="quietly update", action="store_true", default=False
    )
    args = parser.parse_args()

    if args.quiet is False:
        print("Checking for changes...")

    ins = GitDotfileInspector(args.p, args.home)
    changes = ins.determine_changes()

    if args.quiet is False:
        print(
            "{} files have changed:".format(
                "No" if not changes else len(changes)
            )
        )
    if not changes:
        exit(0)
    else:
        if args.quiet is False:
            for changed in changes:
                print(changed)
    if args.quiet is False:
        choice = input("Update repository?")
    else:
        choice = "y"

    if choice == "y":
        # update
        for repo_file, user_file in changes.items():
            if os.path.islink(repo_file):
                # leave symlinks alone
                continue
            shutil.copyfile(user_file, repo_file, follow_symlinks=False)
    else:
        print("Aborted")
